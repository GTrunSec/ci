parameters:
  ciVersion: master
  ciPath: ""
  nixChannelUrls:
    home-manager:
      mangled: home_manager
  nixChannels: {}
  config: MUST_PROVIDE_CONFIG_FILE
  timeoutInMinutes: ""
  task: all
  displayName: ""
  CACHIX_SIGNING_KEY: ""
steps:
- bash: |
    set -eu
    nix -L --show-trace run -f $CI_URL test.${{parameters.task}} --argstr config $CI_CONFIG -c ci-build
  displayName: ${{coalesce(parameters.displayName, format('nix test {0}', parameters.task))}}
  ${{ if ne(parameters.timeoutInMinutes, '') }}:
    timeoutInMinutes: ${{parameters.timeoutInMinutes}}
  env:
    CI_CONFIG: ${{parameters.config}}
    NIX_URL: https://nixos.org/releases/nix/${{parameters.nixVersion}}
    NIX_VERSION: ${{parameters.nixVersion}}
    CI_URL: ${{coalesce(parameters.ciPath, format('https://github.com/arcnmx/ci/archive/{0}.tar.gz', coalesce(parameters.nixChannels.ci, parameters.ciVersion)))}}
    CACHIX_SIGNING_KEY: ${{coalesce(parameters.CACHIX_SIGNING_KEY, '$(cachix.signing.key)')}}
    ${{ each channel in parameters.nixChannels }}:
      NIX_CHANNELS_${{coalesce(parameters.nixChannelUrls[channel.key].mangled, channel.key)}}: ${{channel.value}}
